<!-- src/app/shared/components/data-grid/data-grid.component.html -->
@if (loading()) {
<div class="data-grid-progress">
  <mat-progress-bar mode="indeterminate" />
</div>
} @if (showToolbar()) {
<div class="data-grid-toolbar">
  <div class="data-grid-toolbar-content">
    @if (toolbarTemplate()) {
    <ng-template [ngTemplateOutlet]="toolbarTemplate()" />
    } @else if (toolbarTitle()) {
    <div class="data-grid-toolbar-title">{{ toolbarTitle() }}</div>
    }
  </div>
  <div class="data-grid-toolbar-actions"></div>
</div>
}

<div class="data-grid-main data-grid-layout">
  <div class="data-grid-content data-grid-layout">
    <div #tableContainer class="mat-table-container" [class.mat-table-with-data]="!hasNoResult()">
      <table
        mat-table
        [class.mat-table-hover]="rowHover()"
        [class.mat-table-striped]="rowStriped()"
        [class.mat-table-expandable]="expandable()"
        [class.mat-table-keyboard-navigation]="keyboardNavigation()"
        [dataSource]="dataSource"
        multiTemplateDataRows
        matSort
        [matSortActive]="sortActive()"
        [matSortDirection]="sortDirection()"
        [matSortDisableClear]="sortDisableClear()"
        [matSortDisabled]="sortDisabled()"
        [matSortStart]="sortStart()"
        (matSortChange)="onSortChange($event)"
        [trackBy]="trackBy"
      >
        <!-- Selection Column -->
        @if (rowSelectable() && !hideRowSelectionCheckbox()) {
        <ng-container matColumnDef="DataGridCheckboxColumnDef">
          <th mat-header-cell *matHeaderCellDef class="data-grid-checkbox-cell">
            @if (multiSelectable()) {
            <mat-checkbox
              [checked]="rowSelection.hasValue() && isAllSelected()"
              [indeterminate]="rowSelection.hasValue() && !isAllSelected()"
              (change)="$event ? toggleAllRows() : null"
            />
            }
          </th>
          <td
            mat-cell
            *matCellDef="let row; let index = index; let dataIndex = dataIndex"
            class="data-grid-checkbox-cell"
          >
            @if (!shouldHideCheckbox(row, getIndex(index, dataIndex))) {
            <mat-checkbox
              [disabled]="isRowDisabled(row, getIndex(index, dataIndex))"
              [checked]="rowSelection.isSelected(row)"
              (click)="$event.stopPropagation()"
              (change)="$event ? toggleNormalCheckbox(row) : null"
            />
            }
          </td>
          <td mat-footer-cell *matFooterCellDef class="data-grid-checkbox-cell"></td>
        </ng-container>
        }

        <!-- Data Columns -->
        @for (col of columns(); track col.field) {
        <ng-container
          [matColumnDef]="col.field"
          [sticky]="col.pinned === 'left'"
          [stickyEnd]="col.pinned === 'right'"
        >
          <!-- Header Cell -->
          <th
            mat-header-cell
            *matHeaderCellDef
            [class]="col | colClass"
            [class.mat-table-sticky-left]="col.pinned === 'left'"
            [class.mat-table-sticky-right]="col.pinned === 'right'"
            [style.width]="col.width"
            [style.min-width]="col.width"
            [style.left]="col.left"
            [style.right]="col.right"
          >
            <!-- Prioridad 1: Template especÃ­fico de la columna -->
            @if (col.headerCellTemplate) {
            <ng-template
              [ngTemplateOutlet]="col.headerCellTemplate"
              [ngTemplateOutletContext]="{ $implicit: col, colDef: col }"
            />
            } @else if ($any(headerCellTemplate())?.[col.field] | isTemplateRef) {
            <!-- Prioridad 2: Template general por campo -->
            <ng-template
              [ngTemplateOutlet]="$any(headerCellTemplate())[col.field]"
              [ngTemplateOutletContext]="{ $implicit: col, colDef: col }"
            />
            } @else if (headerCellTemplate() | isTemplateRef) {
            <!-- Prioridad 3: Template general -->
            <ng-template
              [ngTemplateOutlet]="$any(headerCellTemplate())"
              [ngTemplateOutletContext]="{ $implicit: col, colDef: col }"
            />
            } @else if ($any(headerTemplate())?.[col.field] | isTemplateRef) {
            <!-- Prioridad 4: Template por campo en headerTemplate -->
            <ng-template
              [ngTemplateOutlet]="$any(headerTemplate())[col.field]"
              [ngTemplateOutletContext]="{ $implicit: col, colDef: col }"
            />
            } @else if (headerTemplate() | isTemplateRef) {
            <!-- Prioridad 5: Template general en headerTemplate -->
            <ng-template
              [ngTemplateOutlet]="$any(headerTemplate())"
              [ngTemplateOutletContext]="{ $implicit: col, colDef: col }"
            />
            } @else {
            <!-- Comportamiento por defecto -->
            <div class="mat-header-cell-inner">
              <div
                [mat-sort-header]="col.sortProp?.id || col.field"
                [disabled]="!col.sortable"
                [disableClear]="col.sortProp?.disableClear ?? sortDisableClear()"
                [arrowPosition]="col.sortProp?.arrowPosition!"
                [start]="col.sortProp?.start!"
              >
                @if (col.showExpand) {
                <span class="data-grid-expansion-placeholder"></span>
                }
                <span>{{ col.header | toObservable | async }}</span>
                @if (col.sortable) {
                <svg
                  class="data-grid-icon mat-sort-header-icon"
                  viewBox="0 0 24 24"
                  width="24px"
                  height="24px"
                  fill="currentColor"
                  focusable="false"
                >
                  <path d="M3,13H15V11H3M3,6V8H21V6M3,18H9V16H3V18Z" />
                </svg>
                }
              </div>
              <ng-template
                [ngTemplateOutlet]="headerExtraTplBase"
                [ngTemplateOutletContext]="{ $implicit: headerExtraTemplate(), colDef: col }"
              />
            </div>
            }
          </th>

          <!-- Data Cell -->
          <td
            mat-cell
            *matCellDef="let row; let index = index; let dataIndex = dataIndex"
            [class]="col | colClass: row : rowChangeRecord : rowChangeRecord?.currentValue"
            [class.mat-table-sticky-left]="col.pinned === 'left'"
            [class.mat-table-sticky-right]="col.pinned === 'right'"
            [class.focused]="keyboardNavigation() && focusedRowIndex() === dataIndex"
            [style.width]="col.width"
            [style.min-width]="col.width"
            [style.left]="col.left"
            [style.right]="col.right"
            acpGridSelectableCell
            [cellSelectable]="cellSelectable()"
            (cellSelectedChange)="selectCell($event, row, col)"
          >
            @if (cellTemplate() | isTemplateRef) {
            <ng-template
              [ngTemplateOutlet]="$any(cellTemplate())"
              [ngTemplateOutletContext]="{
                    $implicit: row,
                    rowData: row,
                    index: getIndex(index, dataIndex),
                    colDef: col,
                  }"
            />
            } @else { @if ($any(cellTemplate())?.[col.field] | isTemplateRef) {
            <ng-template
              [ngTemplateOutlet]="$any(cellTemplate())[col.field]"
              [ngTemplateOutletContext]="{
                      $implicit: row,
                      rowData: row,
                      index: getIndex(index, dataIndex),
                      colDef: col,
                    }"
            />
            } @else { @if (col.cellTemplate) {
            <ng-template
              [ngTemplateOutlet]="col.cellTemplate!"
              [ngTemplateOutletContext]="{
                        $implicit: row,
                        rowData: row,
                        index: getIndex(index, dataIndex),
                        colDef: col,
                      }"
            />
            } @else { @if (col.showExpand) {
            <button
              class="data-grid-row-expand-button"
              mat-icon-button
              acpDataGridExpansionToggle
              type="button"
              [(opened)]="expansionRowStates()[dataIndex].expanded"
              (toggleChange)="onExpansionChange($event, row, col, dataIndex)"
            >
              <svg
                class="data-grid-icon data-grid-row-expand-icon"
                viewBox="0 0 24 24"
                width="24px"
                height="24px"
                fill="currentColor"
                focusable="false"
              >
                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
              </svg>
            </button>
            }
            <acp-data-grid-cell
              [rowData]="row"
              [colDef]="col"
              [placeholder]="emptyValuePlaceholder()"
              (rowDataChange)="onRowDataChange($event)"
            />
            } } }
          </td>

          <!-- Footer Cell -->
          <td
            mat-footer-cell
            *matFooterCellDef
            [class.mat-table-sticky-left]="col.pinned === 'left'"
            [class.mat-table-sticky-right]="col.pinned === 'right'"
            [style.width]="col.width"
            [style.min-width]="col.width"
            [style.left]="col.left"
            [style.right]="col.right"
          >
            @if (col.showExpand) {
            <span class="data-grid-expansion-placeholder"></span>
            } @if (summaryTemplate() | isTemplateRef) {
            <ng-template
              [ngTemplateOutlet]="$any(summaryTemplate())"
              [ngTemplateOutletContext]="{ $implicit: col, colDef: col, data: data() }"
            />
            } @else { @if ($any(summaryTemplate())?.[col.field] | isTemplateRef) {
            <ng-template
              [ngTemplateOutlet]="$any(summaryTemplate())[col.field]"
              [ngTemplateOutletContext]="{
                      $implicit: getColData(data(), col),
                      colData: getColData(data(), col),
                      colDef: col,
                    }"
            />
            } @else {
            <acp-data-grid-cell
              [summary]="true"
              [data]="data()"
              [colDef]="col"
              [placeholder]="emptyValuePlaceholder()"
            />
            } }
          </td>
        </ng-container>
        }

        <!-- Header Row -->
        @if (!useContentHeaderRowTemplate()) {
        <tr mat-header-row *matHeaderRowDef="displayedColumns(); sticky: true"></tr>
        }

        <!-- Data Rows -->
        @if (!useContentRowTemplate()) {
        <tr
          mat-row
          *matRowDef="
              let row;
              let index = index;
              let dataIndex = dataIndex;
              columns: displayedColumns()
            "
          [class]="row | rowClass: index : dataIndex : rowClassFormatter()"
          [class.selected]="rowSelection.isSelected(row)"
          [class.focused]="keyboardNavigation() && focusedRowIndex() === dataIndex"
          [class.highlighted]="highlightedRowIndex() === dataIndex"
          (click)="selectRow($event, row, getIndex(index, dataIndex))"
          (contextmenu)="contextmenu($event, row, getIndex(index, dataIndex))"
        ></tr>
        }

        <!-- Summary Row -->
        @if (whetherShowSummary()) {
        <tr mat-footer-row *matFooterRowDef="displayedColumns(); sticky: true"></tr>
        }

        <!-- Expansion Row -->
        @if (expandable()) {
        <ng-container matColumnDef="DataGridExpansionColumnDef">
          <td
            mat-cell
            *matCellDef="let row; let dataIndex = dataIndex"
            [attr.colspan]="displayedColumns().length"
          >
            <div class="data-grid-expansion-detail-wrapper">
              <div class="data-grid-expansion-detail">
                <ng-template
                  [ngTemplateOutlet]="expansionTemplate()"
                  [ngTemplateOutletContext]="{
                      $implicit: row,
                      rowData: row,
                      index: dataIndex,
                      expanded: expansionRowStates()[dataIndex].expanded,
                    }"
                />
              </div>
            </div>
          </td>
        </ng-container>
        <tr
          mat-row
          *matRowDef="let row; columns: ['DataGridExpansionColumnDef']; let dataIndex = dataIndex"
          class="data-grid-expansion"
          [class]="expansionRowStates()[dataIndex].expanded ? 'expanded' : 'collapsed'"
        ></tr>
        }
      </table>
    </div>

    <!-- No result -->
    @if (hasNoResult()) {
    <div class="data-grid-no-result">
      @if (noResultTemplate()) {
      <ng-template [ngTemplateOutlet]="noResultTemplate()" />
      } @else { {{ noResultText() }} }
    </div>
    }

    <!-- Infinite Scroll Loading Indicator -->
    @if (infiniteScroll() && isLoadingMore()) {
    <div class="data-grid-infinite-scroll-loading">
      <mat-progress-bar mode="indeterminate" />
    </div>
    }
  </div>
</div>

<div class="data-grid-footer">
  <!-- Pagination -->
  @if (!infiniteScroll() && showPaginator()) {
  <div class="data-grid-pagination">
    @if (paginationTemplate()) {
    <ng-template [ngTemplateOutlet]="paginationTemplate()" />
    } @else {
    <mat-paginator
      [class.mat-paginator-hidden]="!showPaginator()"
      [showFirstLastButtons]="showFirstLastButtons()"
      [length]="length()"
      [pageIndex]="pageIndex()"
      [pageSize]="pageSize()"
      [pageSizeOptions]="pageSizeOptions()"
      [hidePageSize]="hidePageSize()"
      (page)="onPage($event)"
      [disabled]="pageDisabled()"
    />
    }
  </div>
  }
</div>

<!-- Header template for extra content -->
<ng-template #headerExtraTplBase let-headerExtraTemplate let-col="colDef">
  @if (headerExtraTemplate | isTemplateRef) {
  <ng-template
    [ngTemplateOutlet]="headerExtraTemplate"
    [ngTemplateOutletContext]="{ $implicit: col, colDef: col }"
  />
  } @else { @if ($any(headerExtraTemplate)?.[col.field] | isTemplateRef) {
  <ng-template
    [ngTemplateOutlet]="headerExtraTemplate[col.field]"
    [ngTemplateOutletContext]="{ $implicit: col, colDef: col }"
  />
  } }
</ng-template>
