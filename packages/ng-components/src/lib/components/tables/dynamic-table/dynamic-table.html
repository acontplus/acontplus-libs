<div class="acp-dynamic-table">
  <div class="acp-table-container small-table">
    <table #sort="matSort" [dataSource]="dataSource.data" mat-table matSort>
      @if (columnDefinitions) {
      <!-- Checkbox Column -->
      @if (showSelectBox()) {
      <ng-container matColumnDef="select">
        <th *matHeaderCellDef mat-header-cell>
          @if (multipleSelection()) {
          <mat-checkbox
            (change)="$event ? masterToggle() : null"
            (click)="$event.stopPropagation()"
            [aria-label]="checkboxLabel()"
            [checked]="selection.hasValue() && isAllSelected()"
            [indeterminate]="selection.hasValue() && !isAllSelected()"
          />
          }
        </th>
        <td *matCellDef="let row" mat-cell>
          <mat-checkbox
            (change)="$event ? selectRow(row) : null"
            (click)="$event.stopPropagation()"
            [aria-label]="checkboxLabel(row)"
            [checked]="selection.isSelected(row)"
            [disabled]="row.disableSelection"
          />
        </td>
        <td *matFooterCellDef mat-footer-cell></td>
      </ng-container>
      }

      <!-- Dynamic Columns -->
      @for (col of columnDefinitions; track col.key) {
      <ng-container [matColumnDef]="col.key">
        <th *matHeaderCellDef mat-header-cell>{{ col.label }}</th>

        <td
          mat-cell
          *matCellDef="let element; let i = index"
          [ngClass]="{ highlighted: highlightRowIndex() === i }"
        >
          @if (col.key === 'op') {
          <div class="d-flex flex-row gap-1">
            @if (col.templateOutlet) {
            <ng-container
              *ngTemplateOutlet="
                        col.templateOutlet;
                        context: { $implicit: element, index: i }
                      "
            />
            } @else if (rowTemplate()) {
            <ng-container
              *ngTemplateOutlet="rowTemplate(); context: { $implicit: element, index: i }"
            />
            }
          </div>
          } @else { @switch (col.type) { @case ('image') {
          <img [src]="element[col.key]" class="img-fluid img-thumbnail my-1" width="50" alt="" />
          } @case ('number') {
          <div>{{ element[col.key] | number: '1.2' : locale() }}</div>
          } @case ('date') {
          <div>{{ element[col.key] | date: 'dd.MM.yyyy' }}</div>
          } @case ('expand') {
          <button mat-icon-button aria-label="expand row" (click)="onExpand($event, element)">
            @if (expandedElement === element) {
            <mat-icon>keyboard_arrow_up</mat-icon>
            } @else {
            <mat-icon>keyboard_arrow_down</mat-icon>
            }
          </button>
          } @case ('template') {
          <ng-container
            *ngTemplateOutlet="
                        col.templateOutlet;
                        context: { $implicit: element, index: i }
                      "
          />
          } @case ('custom') {
          <ng-container #dynamicContent />
          } @default {
          <div>{{ element[col.key] }}</div>
          } } }
        </td>

        <td *matFooterCellDef mat-footer-cell>
          @if (col.index === 0) {
          <div>Total</div>
          } @if (col.hasFooter) {
          <div>{{ col.key | getTotal: dataSource.data }}</div>
          }
        </td>
      </ng-container>
      }

      <!-- Expanded Detail Row -->
      @if (showExpand() && expandedDetail) {
      <ng-container matColumnDef="expandedDetail">
        <td
          mat-cell
          *matCellDef="let element; let i = index"
          [attr.colspan]="columnsToDisplayWithExpand.length"
        >
          <div class="m-0 p-0 acp-detail-expand" [class.acp-expanded]="element === expandedElement">
            <ng-container
              *ngTemplateOutlet="expandedDetail; context: { $implicit: element, index: i }"
            />
          </div>
        </td>
      </ng-container>
      }

      <!-- Header Row -->
      <tr mat-header-row *matHeaderRowDef="columnsToDisplayWithExpand"></tr>

      <!-- Data Rows -->
      @if (showExpand() && expandedDetail) {
      <!-- Regular Row -->
      <tr
        mat-row
        *matRowDef="let row; columns: columnsToDisplayWithExpand; when: isNormalRow"
        class="acp-dynamic-table-row"
        [class.acp-dynamic-table-expanded-row]="expandedElement === row"
        [ngStyle]="getRowStyle(row)"
        (click)="expandedElement = expandedElement === row ? null : row"
      ></tr>

      <!-- Expanded Row -->
      <tr
        mat-row
        *matRowDef="let row; columns: ['expandedDetail']; when: isExpandedRow"
        class="acp-dynamic-table-detail-row"
      ></tr>
      } @else {
      <!-- Regular Row without expansion -->
      <tr
        mat-row
        *matRowDef="let row; columns: columnsToDisplayWithExpand"
        [ngStyle]="getRowStyle(row)"
      ></tr>
      }

      <!-- No Data Row -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell text-center" [attr.colspan]="columnsToDisplayWithExpand.length">
          No records found
        </td>
      </tr>

      <!-- Footer -->
      @if (showFooter() && dataSource.data.length > 0) {
      <tr mat-footer-row *matFooterRowDef="columnsToDisplayWithExpand"></tr>
      } }
    </table>
  </div>

  @if (enablePagination() && paginationConfig) {
  <mat-paginator
    #paginator
    [disabled]="isLoadingData()"
    (page)="handlePageEvent($event)"
    [length]="paginationConfig.totalRecords"
    [pageSize]="paginationConfig.pageSize"
    [pageSizeOptions]="paginationConfig.pageSizeOptions || []"
    [showFirstLastButtons]="paginationConfig.showFirstLastButtons"
    [pageIndex]="paginationConfig.pageIndex"
    [hidePageSize]="paginationConfig.hidePageSize"
    [disabled]="paginationConfig.disabled"
    aria-label="Select page"
  />
  }
</div>
